async function sendTicket() {
    const name = document.getElementById('cust-name').value;
    const phone = document.getElementById('cust-phone').value;
    const branch = document.getElementById('cust-branch').value;
    const task = document.getElementById('cust-task').value;
    const btn = document.getElementById('btn-submit');

    if (!name || !phone) {
        alert("נא למלא שם וטלפון");
        return;
    }

    btn.innerText = "שולח...";
    btn.disabled = true;

    const BASE_URL = "https://chat.bar-t.co.il/api/v1/accounts/2";
    const INBOX_ID = "LgubEAWU1P3FerjtJ6zMKghq"; 

    try {
        // 1. יצירת איש קשר (Contact)
        const contactRes = await fetch(`${BASE_URL}/inboxes/${INBOX_ID}/contacts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, phone_number: phone })
        });
        const contactData = await contactRes.json();
        const sourceId = contactData.source_id;
        const contactId = contactData.id; // המזהה הפנימי של איש הקשר

        // 2. יצירת שיחה (Conversation) - זה השלב שהיה חסר!
        const convRes = await fetch(`${BASE_URL}/conversations`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'api_access_token': 'CuQaTss4JDPsmtqRjMXW7oeM' // השתמשתי בטוקן ששלחת קודם
            },
            body: JSON.stringify({ 
                source_id: sourceId, 
                inbox_id: 10, // ה-ID של התיבה (איחוד הצלה)
                contact_id: contactId 
            })
        });
        const convData = await convRes.json();
        const conversationId = convData.id;

        // 3. שליחת ההודעה לתוך השיחה שנוצרה
        await fetch(`${BASE_URL}/conversations/${conversationId}/messages`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'api_access_token': 'CuQaTss4JDPsmtqRjMXW7oeM' 
            },
            body: JSON.stringify({ 
                content: `קריאה חדשה:\nשם: ${name}\nסניף: ${branch}\nתיאור: ${task}`, 
                message_type: "incoming" 
            })
        });

        document.getElementById('form-content').style.display = 'none';
        document.getElementById('success-message').style.display = 'block';

    } catch (e) {
        console.error(e);
        alert("שגיאה בשליחה. נסה שוב.");
        btn.disabled = false;
        btn.innerText = "שלח קריאה";
    }
}
